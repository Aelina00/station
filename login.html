<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä–∞–∫–æ–ª –ê–≤—Ç–æ–±–µ–∫–µ—Ç–∏</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            overflow: hidden;
        }

        /* LOGIN SCREEN */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1e3a8a, #1e40af, #3b82f6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-box {
            background: rgba(30, 41, 138, 0.9);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid #3b82f6;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .login-logo {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 30px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 300px;
        }

        .login-input {
            padding: 15px 20px;
            background: rgba(30, 64, 175, 0.3);
            border: 1px solid #3b82f6;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            text-align: center;
        }

        .login-input::placeholder {
            color: #94a3b8;
        }

        .login-input:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(30, 64, 175, 0.5);
        }

        .login-btn {
            padding: 15px 30px;
            background: #22c55e;
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            background: #16a34a;
            transform: translateY(-2px);
        }

        .login-error {
            color: #ef4444;
            margin-top: 10px;
            font-weight: 500;
        }

        /* HEADER */
        .header {
            background: #1e3a8a;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #3b82f6;
        }

        .station-info {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .logo {
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .station-text h1 {
            font-size: 36px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
        }

        .station-text p {
            font-size: 16px;
            color: #94a3b8;
            font-weight: 500;
        }

        .time-info {
            text-align: right;
        }

        .current-time {
            font-size: 48px;
            font-weight: 300;
            color: #fff;
            font-family: 'Inter', monospace;
            line-height: 1;
        }

        .current-date {
            font-size: 18px;
            color: #94a3b8;
            margin-top: 8px;
        }

        .weather {
            position: absolute;
            top: 25px;
            right: 200px;
            background: rgba(30, 64, 175, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
        }

        .weather-temp {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        .weather-city {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 5px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* –ó–ê–ì–û–õ–û–í–ö–ò –¢–ê–ë–õ–ò–¶–´ */
        .table-header {
            background: #1e293b;
            padding: 15px 40px;
            border-bottom: 2px solid #3b82f6;
            display: grid;
            grid-template-columns: 250px 120px 160px 80px 100px 80px 180px 150px 120px;
            gap: 20px;
            align-items: center;
        }

        .header-cell {
            font-size: 14px;
            font-weight: 600;
            color: #3b82f6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* –†–ï–ô–°–´ */
        .departures {
            height: calc(100vh - 230px);
            overflow: hidden;
            padding: 0;
        }

        .route {
            display: grid;
            grid-template-columns: 250px 120px 160px 80px 100px 80px 180px 150px 120px;
            gap: 20px;
            align-items: center;
            padding: 5px 40px;
            min-height: 80px;
            border-bottom: 1px solid #1f2937;
        }

        .route:nth-child(odd) {
            background: #111827;
        }

        .route:nth-child(even) {
            background: #374151;
        }

        .route-destination {
            font-size: 26px;
            font-weight: 600;
            color: #fff;
        }

        .route-time {
            font-size: 30px;
            font-weight: 500;
            color: #fbbf24;
            font-family: 'Inter', monospace;
        }

        .route-status {
            font-size: 15px;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 15px;
            text-align: center;
            text-transform: uppercase;
        }

        .status-waiting {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }

        .status-boarding {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
            animation: pulse 2s infinite;
        }

        .status-delayed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .status-departed {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
            border: 1px solid #6b7280;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .route-vehicle {
            font-size: 16px;
            font-weight: 500;
            color: #60a5fa;
        }

        .route-seats {
            font-size: 16px;
            color: #fff;
            font-weight: 500;
        }

        .route-available {
            font-size: 16px;
            color: #22c55e;
            font-weight: 500;
        }

        .route-carrier {
            font-size: 15px;
            color: #d1d5db;
        }

        .route-driver {
            font-size: 15px;
            color: #d1d5db;
        }

        .route-price {
            font-size: 18px;
            font-weight: 600;
            color: #22c55e;
        }

        /* –ë–ï–ì–£–©–ê–Ø –°–¢–†–û–ö–ê */
        .ticker {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #374151;
            height: 50px;
            overflow: hidden;
            display: flex;
            align-items: center;
        }

        .ticker-text {
            white-space: nowrap;
            color: #fff;
            font-size: 18px;
            font-weight: 500;
            animation: scroll 45s linear infinite;
            padding-left: 100%;
        }

        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #6b7280;
        }

        .empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 24px;
        }

        .display-screen {
            display: none;
        }

        .display-screen.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div class="login-screen" id="login-screen">
        <div class="login-box">
            <div class="login-logo">üöå</div>
            <div class="login-title">–ö–ê–†–ê–ö–û–õ –ê–í–¢–û–ë–ï–ö–ï–¢–ò</div>
            <div class="login-form">
                <input type="text" class="login-input" id="username" placeholder="–ö–æ–ª–¥–æ–Ω—É—É—á—É –∞—Ç—ã ‚Ä¢ –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="password" class="login-input" id="password" placeholder="–°—ã—Ä —Å”©–∑ ‚Ä¢ –ü–∞—Ä–æ–ª—å">
                <button class="login-btn" onclick="login()">–ö–ò–†“Æ“Æ ‚Ä¢ –í–û–ô–¢–ò</button>
                <div class="login-error" id="login-error"></div>
            </div>
        </div>
    </div>

    <!-- DISPLAY SCREEN -->
    <div class="display-screen" id="display-screen">
        <div class="header">
            <div class="station-info">
                <div class="logo">üöå</div>
                <div class="station-text">
                    <h1>–ö–ê–†–ê–ö–û–õ –ê–í–¢–û–ë–ï–ö–ï–¢–ò</h1>
                    <p>–ö–ï–¢“Æ“Æ–õ”®–† ‚Ä¢ –û–¢–ü–†–ê–í–õ–ï–ù–ò–Ø ‚Ä¢ DEPARTURES</p>
                </div>
            </div>
            <div class="time-info">
                <div class="current-time" id="current-time"></div>
                <div class="current-date" id="current-date"></div>
            </div>
            <div class="weather">
                <div class="weather-temp" id="weather-temp">+18¬∞</div>
                <div class="weather-city">–ö–∞—Ä–∞–∫–æ–ª</div>
            </div>
            <button class="logout-btn" onclick="logout()">–ß–´–ì–£–£</button>
        </div>

        <div class="table-header">
            <div class="header-cell">–ë–ê–ì–´–¢ ‚Ä¢ –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï</div>
            <div class="header-cell">–£–ë–ê–ö–´–¢ ‚Ä¢ –í–†–ï–ú–Ø</div>
            <div class="header-cell">–ê–ë–ê–õ–´ ‚Ä¢ –°–¢–ê–¢–£–°</div>
            <div class="header-cell">–í–ò–î</div>
            <div class="header-cell">–û–†–£–ù–î–ê–†</div>
            <div class="header-cell">–ë–û–®–¢–û–ö</div>
            <div class="header-cell">–¢–ê–®–£–£–ß–£ ‚Ä¢ –ü–ï–†–ï–í–û–ó–ß–ò–ö</div>
            <div class="header-cell">–ê–ô–î–û–û–ß–£ ‚Ä¢ –í–û–î–ò–¢–ï–õ–¨</div>
            <div class="header-cell">–ë–ê–ê–°–´ ‚Ä¢ –¶–ï–ù–ê</div>
        </div>

        <div class="departures" id="departures-container">
            <!-- –†–µ–π—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
        </div>

        <div class="ticker">
            <div class="ticker-text" id="ticker-text">
                –ö–ê–†–ê–ö–û–õ –ê–í–¢–û–ë–ï–ö–ï–¢–ò ‚Ä¢ –ö–ï–¢“Æ“Æ–õ”®–† –ö“Æ–ù–î”® 06:00–¥”©–Ω 22:00–≥”© —á–µ–π–∏–Ω ‚Ä¢ –ë–ò–õ–ï–¢–¢–ï–†–î–ò –ö–ê–°–°–ê–î–ê –ê–õ–´“¢–´–ó ‚Ä¢ –ë–ê–ì–ê–ñ–î–´ –ö–ê–ú–ê–ö–ö–ê –¢–û–ü–¢–û–û –ú–ò–õ–î–ï–¢–¢“Æ“Æ ‚Ä¢ –ö–û–û–ü–°–£–ó–î–£–ö –≠–†–ï–ñ–ï–õ–ï–†–ò–ù –°–ê–ö–¢–ê“¢–´–ó
            </div>
        </div>
    </div>

    <script>
        let buses = [];
        let speechQueue = [];
        let isSpeaking = false;
        let lastAnnouncedBus = null;
        let tickerIndex = 0;
        let lastDataHash = '';
        let currentUser = null;
        const MAX_VISIBLE_ROUTES = 10;

        // –°–ò–°–¢–ï–ú–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
        const users = {
            admin: { password: 'admin123', role: 'admin', name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' },
            operator: { password: 'display123', role: 'display', name: '–û–ø–µ—Ä–∞—Ç–æ—Ä' }
        };

        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            if (!username || !password) {
                showLoginError('–ö–æ–ª–¥–æ–Ω—É—É—á—É –∞—Ç—ã –∂–∞–Ω–∞ —Å—ã—Ä —Å”©–∑–¥“Ø –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑!');
                return;
            }

            const user = users[username];
            if (!user || user.password !== password) {
                showLoginError('–¢—É—É—Ä–∞ —ç–º–µ—Å –∫–æ–ª–¥–æ–Ω—É—É—á—É –∞—Ç—ã –∂–µ —Å—ã—Ä —Å”©–∑!');
                return;
            }

            currentUser = { ...user, username };
            
            if (user.role === 'admin') {
                // –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
                window.location.href = 'admin.html';
            } else {
                // –ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('display-screen').classList.add('active');
                init();
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('display-screen').classList.remove('active');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-error').textContent = '';
        }

        function showLoginError(message) {
            document.getElementById('login-error').textContent = message;
            setTimeout(() => {
                document.getElementById('login-error').textContent = '';
            }, 5000);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ —Ñ–æ—Ä–º–µ –ª–æ–≥–∏–Ω–∞
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('login-screen').style.display !== 'none') {
                login();
            }
        });

        const languages = {
            kg: {
                voice: 'ru-RU',
                announcements: {
                    fiveMinutes: '{route} –±–∞–≥—ã—Ç—ã–Ω–∞ {vehicle} 5 –º“Ø–Ω”©—Ç—Ç”©–Ω –∫–∏–π–∏–Ω –∫–µ—Ç–µ—Ç. –ñ–æ–ª–æ–æ—á—É–ª–∞—Ä –¥–∞—è—Ä–¥–∞–Ω—ã“£—ã–∑',
                    boarding: '{route} –±–∞–≥—ã—Ç—ã–Ω–∞ {vehicle} –æ—Ç—É—Ä–≥—É–∑—É—É –±–∞—à—Ç–∞–ª–¥—ã. –ñ–æ–ª–æ–æ—á—É–ª–∞—Ä –æ—Ç—É—Ä–≥—É–∑—É—É–≥–∞ ”©—Ç“Ø“£“Ø–∑',
                    departed: '{route} –±–∞–≥—ã—Ç—ã–Ω–∞ {vehicle} –∫–µ—Ç—Ç–∏'
                }
            },
            ru: {
                voice: 'ru-RU',
                announcements: {
                    fiveMinutes: '{vehicle} –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é {route} –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç. –ü–∞—Å—Å–∞–∂–∏—Ä—ã –≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ –ø–æ—Å–∞–¥–∫–µ',
                    boarding: '–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ—Å–∞–¥–∫–∞ –Ω–∞ {vehicle} –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é {route}. –ü–∞—Å—Å–∞–∂–∏—Ä—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç–µ –Ω–∞ –ø–æ—Å–∞–¥–∫—É',
                    departed: '{vehicle} –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é {route} –æ—Ç–ø—Ä–∞–≤–∏–ª—Å—è'
                }
            },
            en: {
                voice: 'en-US',
                announcements: {
                    fiveMinutes: '{vehicle} to {route} departs in 5 minutes. Passengers please prepare for boarding',
                    boarding: '{vehicle} to {route} is now boarding. Passengers please proceed to boarding',
                    departed: '{vehicle} to {route} has departed'
                }
            }
        };

        const tickerMessages = [
            '–ö–ê–†–ê–ö–û–õ –ê–í–¢–û–ë–ï–ö–ï–¢–ò ‚Ä¢ –ö–ï–¢“Æ“Æ–õ”®–† –ö“Æ–ù–î”® 06:00–¥”©–Ω 22:00–≥”© —á–µ–π–∏–Ω',
            '–ë–ò–õ–ï–¢–¢–ï–†–î–ò –ö–ê–°–°–ê–î–ê –ê–õ–´“¢–´–ó ‚Ä¢ –ù–û–ú–ï–† 1-2 ‚Ä¢ –ë–ò–õ–ï–¢–´ –í –ö–ê–°–°–ï ‚Ññ1-2',
            '–ë–ê–ì–ê–ñ–î–´ –ö–ê–ú–ê–ö–ö–ê –¢–û–ü–¢–û–û –ú–ò–õ–î–ï–¢–¢“Æ“Æ ‚Ä¢ –ë–ê–ì–ê–ñ –°–î–ê–í–ê–¢–¨ –í –ö–ê–ú–ï–†–£ –•–†–ê–ù–ï–ù–ò–Ø',
            '–ú–ê–ê–õ–´–ú–ê–¢ “Æ–ß“Æ–ù: +996 3922 5-15-15 ‚Ä¢ –°–ü–†–ê–í–ö–ò –ü–û –¢–ï–õ–ï–§–û–ù–£',
            '–ö–û–û–ü–°–£–ó–î–£–ö –≠–†–ï–ñ–ï–õ–ï–†–ò–ù –°–ê–ö–¢–ê“¢–´–ó ‚Ä¢ –°–û–ë–õ–Æ–î–ê–ô–¢–ï –ü–†–ê–í–ò–õ–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò'
        ];

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                now.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            document.getElementById('current-date').textContent = 
                now.toLocaleDateString('ru-RU', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long'
                });
        }

        async function updateWeather() {
            try {
                const response = await fetch(`https://wttr.in/Karakol?format=j1`);
                
                if (response.ok) {
                    const data = await response.json();
                    const temp = Math.round(data.current_condition[0].temp_C);
                    const sign = temp > 0 ? '+' : '';
                    document.getElementById('weather-temp').textContent = `${sign}${temp}¬∞`;
                } else {
                    useLocalWeather();
                }
            } catch (error) {
                useLocalWeather();
            }
        }

        function useLocalWeather() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const hour = now.getHours();
            let temp;
            
            if (month >= 12 || month <= 2) { 
                temp = Math.floor(Math.random() * 15) - 10;
                if (hour >= 22 || hour <= 6) temp -= 3;
            } else if (month >= 3 && month <= 5) { 
                temp = Math.floor(Math.random() * 20) + 5;
                if (hour >= 12 && hour <= 16) temp += 3;
            } else if (month >= 6 && month <= 8) { 
                temp = Math.floor(Math.random() * 15) + 15;
                if (hour >= 12 && hour <= 16) temp += 5;
            } else { 
                temp = Math.floor(Math.random() * 20) + 0;
                if (hour >= 22 || hour <= 6) temp -= 2;
            }
            
            const sign = temp > 0 ? '+' : '';
            document.getElementById('weather-temp').textContent = `${sign}${temp}¬∞`;
        }

        function updateTicker() {
            const text = tickerMessages[tickerIndex];
            document.getElementById('ticker-text').textContent = text;
            tickerIndex = (tickerIndex + 1) % tickerMessages.length;
        }

        function renderRoutes() {
            const container = document.getElementById('departures-container');
            
            if (buses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üöå</div>
                        <div class="empty-text">–ê–≤—Ç–æ–±—É—Å—Ç–∞—Ä –∂–æ–∫ ‚Ä¢ –ù–µ—Ç –∞–≤—Ç–æ–±—É—Å–æ–≤</div>
                    </div>
                `;
                return;
            }

            const sorted = [...buses]
                .filter(bus => bus.status !== 'departed')
                .sort((a, b) => {
                    const timeA = parseTimeToMinutes(a.time);
                    const timeB = parseTimeToMinutes(b.time);
                    return timeA - timeB;
                })
                .slice(0, MAX_VISIBLE_ROUTES);

            container.innerHTML = sorted.map(bus => `
                <div class="route">
                    <div class="route-destination">${bus.route}</div>
                    <div class="route-time">${bus.time}</div>
                    <div class="route-status status-${bus.status}">
                        ${getStatusText(bus.status)}
                    </div>
                    <div class="route-vehicle">${getVehicleText(bus.vehicle)}</div>
                    <div class="route-seats">${bus.seats}</div>
                    <div class="route-available">${bus.available || bus.seats}</div>
                    <div class="route-carrier">${bus.carrier}</div>
                    <div class="route-driver">${bus.driver}</div>
                    <div class="route-price">${bus.price || '---'} —Å–æ–º</div>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const texts = {
                'waiting': '–ö“Ø—Ç“Ø“Ø–¥”©',
                'boarding': '–û—Ç—É—Ä–≥—É–∑—É—É',
                'delayed': '–ö–µ—á–∏–≥“Ø“Ø',
                'departed': '–ö–µ—Ç—Ç–∏'
            };
            return texts[status] || status;
        }

        function getVehicleText(vehicle) {
            const texts = {
                'bus': '–ê–≤—Ç–æ–±—É—Å',
                'minibus': '–ú–∞—Ä—à—Ä—É—Ç–∫–∞'
            };
            return texts[vehicle] || '–ê–≤—Ç–æ–±—É—Å';
        }

        function parseTimeToMinutes(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function makeTrilingualAnnouncement(type, route, vehicle, busId) {
            const announceKey = `${busId}_${type}`;
            if (lastAnnouncedBus === announceKey) return;
            lastAnnouncedBus = announceKey;
            
            console.log(`üîä –û–±—ä—è–≤–ª–µ–Ω–∏–µ: ${type} –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞ ${route}`);
            
            const vehicleText = getVehicleText(vehicle);
            
            const kgText = languages.kg.announcements[type]
                .replace('{route}', route)
                .replace('{vehicle}', vehicleText);
            addSpeech(kgText, languages.kg.voice, '–ö—ã—Ä–≥—ã–∑—Å–∫–∏–π');
            
            setTimeout(() => {
                const ruText = languages.ru.announcements[type]
                    .replace('{route}', route)
                    .replace('{vehicle}', vehicleText);
                addSpeech(ruText, languages.ru.voice, '–†—É—Å—Å–∫–∏–π');
            }, 6000);
            
            setTimeout(() => {
                const enText = languages.en.announcements[type]
                    .replace('{route}', route)
                    .replace('{vehicle}', vehicle === 'bus' ? 'Bus' : 'Minibus');
                addSpeech(enText, languages.en.voice, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π');
            }, 12000);
        }

        function addSpeech(text, voice, language) {
            speechQueue.push({ text, voice, language });
            console.log(`üìù –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å [${language}]: "${text}"`);
        }

        function processSpeech() {
            if (!isSpeaking && speechQueue.length > 0) {
                const speech = speechQueue.shift();
                speak(speech.text, speech.voice, speech.language);
            }
        }

        function speak(text, voiceLang, language) {
            if (!('speechSynthesis' in window)) {
                console.log('‚ùå Speech synthesis –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                isSpeaking = false;
                return;
            }
            
            speechSynthesis.cancel();
            isSpeaking = true;
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (voiceLang === 'en-US') {
                utterance.lang = 'en-US';
                utterance.rate = 0.7;
                utterance.pitch = 1.0;
            } else {
                utterance.lang = 'ru-RU';
                utterance.rate = 0.75;
                utterance.pitch = 1.0;
            }
            
            const setVoice = () => {
                const voices = speechSynthesis.getVoices();
                let selectedVoice = null;
                
                if (voiceLang === 'en-US') {
                    selectedVoice = voices.find(voice => 
                        voice.lang === 'en-US' && (
                            voice.name.includes('Google') || 
                            voice.name.includes('Microsoft') ||
                            voice.name.includes('Samantha') ||
                            voice.name.includes('Karen') ||
                            voice.name.includes('Daniel')
                        )
                    ) || voices.find(voice => voice.lang === 'en-US') 
                      || voices.find(voice => voice.lang.startsWith('en'));
                } else {
                    selectedVoice = voices.find(voice => 
                        voice.lang === 'ru-RU' && (
                            voice.name.includes('Google') || 
                            voice.name.includes('Microsoft') ||
                            voice.name.includes('Yandex')
                        )
                    ) || voices.find(voice => voice.lang === 'ru-RU') 
                      || voices.find(voice => voice.lang.startsWith('ru'));
                }
                
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                    console.log(`üé§ –ì–æ–ª–æ—Å: ${selectedVoice.name} [${language}]`);
                } else {
                    console.log(`‚ö†Ô∏è –ì–æ–ª–æ—Å –¥–ª—è ${voiceLang} –Ω–µ –Ω–∞–π–¥–µ–Ω [${language}]`);
                }
                
                utterance.volume = 0.9;
                
                utterance.onstart = () => {
                    console.log(`üîä –ü—Ä–æ–∏–∑–Ω–æ—à—É [${language}]: "${text}"`);
                };
                
                utterance.onend = () => {
                    console.log(`‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ [${language}]: "${text}"`);
                    isSpeaking = false;
                };
                
                utterance.onerror = (event) => {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ speech [${language}]:`, event.error);
                    isSpeaking = false;
                };
                
                speechSynthesis.speak(utterance);
            };
            
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.addEventListener('voiceschanged', setVoice, { once: true });
            } else {
                setVoice();
            }
        }

        function checkAnnouncements() {
            const now = new Date();
            const currentHours = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentTotalMinutes = currentHours * 60 + currentMinutes;
            
            console.log(`‚è∞ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π: ${currentHours}:${currentMinutes.toString().padStart(2, '0')}`);
            
            buses.forEach(bus => {
                if (!bus.announcements) {
                    bus.announcements = {
                        fiveMinutes: false,
                        boarding: false,
                        departed: false
                    };
                }
                
                const [busHours, busMinutes] = bus.time.split(':').map(Number);
                const busTotalMinutes = busHours * 60 + busMinutes;
                const diffMinutes = busTotalMinutes - currentTotalMinutes;

                // –ó–∞ 5 –º–∏–Ω—É—Ç –¥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                if (diffMinutes === 5 && !bus.announcements.fiveMinutes && bus.status === 'waiting') {
                    console.log(`üì¢ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –∑–∞ 5 –º–∏–Ω—É—Ç: ${bus.route}`);
                    bus.announcements.fiveMinutes = true;
                    makeTrilingualAnnouncement('fiveMinutes', bus.route, bus.vehicle, bus.id);
                }

                // –ü—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ "–ø–æ—Å–∞–¥–∫–∞"
                if (bus.status === 'boarding' && !bus.announcements.boarding) {
                    console.log(`üì¢ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ –ø–æ—Å–∞–¥–∫–µ: ${bus.route}`);
                    bus.announcements.boarding = true;
                    makeTrilingualAnnouncement('boarding', bus.route, bus.vehicle, bus.id);
                }

                // –ü—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ "–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"
                if (bus.status === 'departed' && !bus.announcements.departed) {
                    console.log(`üì¢ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–± –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–∏: ${bus.route}`);
                    bus.announcements.departed = true;
                    makeTrilingualAnnouncement('departed', bus.route, bus.vehicle, bus.id);
                }
            });
        }

        function removeOldBuses() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            const initialCount = buses.length;
            buses = buses.filter(bus => {
                if (bus.status === 'departed') {
                    const busMinutes = parseTimeToMinutes(bus.time);
                    const diffMinutes = currentMinutes - busMinutes;
                    return diffMinutes < 1;
                }
                return true;
            });

            if (buses.length < initialCount) {
                console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ ${initialCount - buses.length} —Å—Ç–∞—Ä—ã—Ö –∞–≤—Ç–æ–±—É—Å–æ–≤`);
                renderRoutes();
            }
        }

        function loadDataFromStorage() {
            try {
                const savedData = localStorage.getItem('karakol-bus-station-display');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    const newBuses = data.buses || [];
                    
                    // –°–æ–∑–¥–∞–µ–º —Ö—ç—à –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
                    const newDataHash = JSON.stringify(newBuses.map(b => ({
                        id: b.id, 
                        route: b.route,
                        time: b.time,
                        status: b.status, 
                        seats: b.seats,
                        available: b.available,
                        carrier: b.carrier,
                        driver: b.driver,
                        price: b.price,
                        vehicle: b.vehicle
                    })));
                    
                    if (newDataHash !== lastDataHash) {
                        console.log('üîÑ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏');
                        buses = newBuses;
                        renderRoutes();
                        lastDataHash = newDataHash;
                    }
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
            }
        }

        window.addEventListener('storage', function(e) {
            if (e.key === 'karakol-bus-station-display') {
                loadDataFromStorage();
            }
        });

        function init() {
            console.log('üöå –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –ö–∞—Ä–∞–∫–æ–ª –∞–≤—Ç–æ–±–µ–∫–µ—Ç–∏ –∑–∞–ø—É—â–µ–Ω');
            
            updateTime();
            updateWeather();
            updateTicker();
            
            setInterval(updateTime, 1000);
            setInterval(updateWeather, 600000);
            setInterval(updateTicker, 20000);
            
            loadDataFromStorage();
            setInterval(loadDataFromStorage, 1000); // –ö–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            setInterval(removeOldBuses, 60000);
            
            setInterval(processSpeech, 1500);
            setInterval(checkAnnouncements, 15000); // –ö–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
            
            if ('speechSynthesis' in window) {
                speechSynthesis.getVoices();
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = () => {
                        console.log('üé§ –ì–æ–ª–æ—Å–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', speechSynthesis.getVoices().length);
                    };
                }
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è
        window.addEventListener('load', function() {
            const savedSession = localStorage.getItem('karakol-session');
            if (savedSession) {
                try {
                    const session = JSON.parse(savedSession);
                    if (session.role === 'display' && session.expires > Date.now()) {
                        currentUser = session;
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('display-screen').classList.add('active');
                        init();
                        return;
                    }
                } catch (e) {
                    localStorage.removeItem('karakol-session');
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ª–æ–≥–∏–Ω–∞
            document.getElementById('login-screen').style.display = 'flex';
        });

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—Ö–æ–¥–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è display —Ä–æ–ª–∏)
        function saveSession() {
            if (currentUser && currentUser.role === 'display') {
                const session = {
                    ...currentUser,
                    expires: Date.now() + (8 * 60 * 60 * 1000) // 8 —á–∞—Å–æ–≤
                };
                localStorage.setItem('karakol-session', JSON.stringify(session));
            }
        }
    </script>
</body>
</html>