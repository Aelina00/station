<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä–∞–∫–æ–ª –ê–≤—Ç–æ–±–µ–∫–µ—Ç–∏</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            overflow: hidden;
        }

        .header {
            background: #1e3a8a;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #3b82f6;
        }

        .station-info {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .logo {
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .station-text h1 {
            font-size: 36px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
        }

        .station-text p {
            font-size: 16px;
            color: #94a3b8;
            font-weight: 500;
        }

        .time-info {
            text-align: right;
        }

        .current-time {
            font-size: 48px;
            font-weight: 300;
            color: #fff;
            font-family: 'Inter', monospace;
            line-height: 1;
        }

        .current-date {
            font-size: 18px;
            color: #94a3b8;
            margin-top: 8px;
        }

        .weather {
            position: absolute;
            top: 25px;
            right: 200px;
            background: rgba(30, 64, 175, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
        }

        .weather-temp {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        .weather-city {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 5px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #374151;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .table-header {
            background: #1e293b;
            padding: 15px 40px;
            border-bottom: 2px solid #3b82f6;
            display: grid;
            grid-template-columns: 250px 120px 160px 80px 100px 80px 180px 150px 120px;
            gap: 20px;
            align-items: center;
        }

        .header-cell {
            font-size: 14px;
            font-weight: 600;
            color: #3b82f6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .departures {
            height: calc(100vh - 230px);
            overflow: hidden;
            padding: 0;
        }

        .route {
            display: grid;
            grid-template-columns: 250px 120px 160px 80px 100px 80px 180px 150px 120px;
            gap: 20px;
            align-items: center;
            padding: 5px 40px;
            min-height: 80px;
            border-bottom: 1px solid #1f2937;
        }

        .route:nth-child(odd) {
            background: #111827;
        }

        .route:nth-child(even) {
            background: #374151;
        }

        .route-destination {
            font-size: 26px;
            font-weight: 600;
            color: #fff;
        }

        .route-time {
            font-size: 30px;
            font-weight: 500;
            color: #fbbf24;
            font-family: 'Inter', monospace;
        }

        .route-status {
            font-size: 15px;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 15px;
            text-align: center;
            text-transform: uppercase;
        }

        .status-waiting {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }

        .status-boarding {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
            animation: pulse 2s infinite;
        }

        .status-delayed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .status-departed {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
            border: 1px solid #6b7280;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .route-vehicle {
            font-size: 16px;
            font-weight: 500;
            color: #60a5fa;
        }

        .route-seats {
            font-size: 16px;
            color: #fff;
            font-weight: 500;
        }

        .route-available {
            font-size: 16px;
            color: #22c55e;
            font-weight: 500;
        }

        .route-carrier {
            font-size: 15px;
            color: #d1d5db;
        }

        .route-driver {
            font-size: 15px;
            color: #d1d5db;
        }

        .route-price {
            font-size: 18px;
            font-weight: 600;
            color: #22c55e;
        }

        .ticker {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #374151;
            height: 50px;
            overflow: hidden;
            display: flex;
            align-items: center;
        }

        .ticker-text {
            white-space: nowrap;
            color: #fff;
            font-size: 18px;
            font-weight: 500;
            animation: scroll 45s linear infinite;
            padding-left: 100%;
        }

        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #6b7280;
        }

        .empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 24px;
        }

        .access-denied {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .access-box {
            background: rgba(15, 23, 42, 0.9);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(239, 68, 68, 0.5);
            max-width: 400px;
        }

        .access-icon {
            font-size: 60px;
            color: #ef4444;
            margin-bottom: 20px;
        }

        .access-title {
            font-size: 24px;
            color: #ef4444;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .access-text {
            color: #94a3b8;
            margin-bottom: 25px;
        }

        .access-btn {
            background: #3b82f6;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .access-btn:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <div class="access-denied" id="access-denied" style="display: none;">
        <div class="access-box">
            <div class="access-icon">üö´</div>
            <div class="access-title">–ú“Ø–º–∫“Ø–Ω—á“Ø–ª“Ø–∫ –∂–æ–∫</div>
            <div class="access-text">–ë—É–ª –±–µ—Ç–∫–µ –∫–∏—Ä“Ø“Ø “Ø—á“Ø–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ç–∞–ª–∞–ø –∫—ã–ª—ã–Ω–∞—Ç</div>
            <button class="access-btn" onclick="goToLogin()">–ö–∏—Ä“Ø“Ø —Ñ–æ—Ä–º–∞—Å—ã–Ω–∞ ”©—Ç“Ø“Ø</button>
        </div>
    </div>

    <div id="display-screen">
        <div class="header">
            <div class="station-info">
                <div class="logo">üöå</div>
                <div class="station-text">
                    <h1>–ö–ê–†–ê–ö–û–õ –ê–í–¢–û–ë–ï–ö–ï–¢–ò</h1>
                    <p>–ö–ï–¢“Æ“Æ–õ”®–† ‚Ä¢ –û–¢–ü–†–ê–í–õ–ï–ù–ò–Ø ‚Ä¢ DEPARTURES</p>
                </div>
            </div>
            <div class="time-info">
                <div class="current-time" id="current-time"></div>
                <div class="current-date" id="current-date"></div>
            </div>
            <div class="weather">
                <div class="weather-temp" id="weather-temp">+18¬∞</div>
                <div class="weather-city">–ö–∞—Ä–∞–∫–æ–ª</div>
            </div>
            <button class="logout-btn" onclick="logout()">–ß–´–ì–£–£</button>
        </div>

        <div class="table-header">
            <div class="header-cell">–ë–ê–ì–´–¢ ‚Ä¢ –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï</div>
            <div class="header-cell">–£–ë–ê–ö–´–¢ ‚Ä¢ –í–†–ï–ú–Ø</div>
            <div class="header-cell">–ê–ë–ê–õ–´ ‚Ä¢ –°–¢–ê–¢–£–°</div>
            <div class="header-cell">–í–ò–î</div>
            <div class="header-cell">–û–†–£–ù–î–ê–†</div>
            <div class="header-cell">–ë–û–®–¢–û–ö</div>
            <div class="header-cell">–¢–ê–®–£–£–ß–£ ‚Ä¢ –ü–ï–†–ï–í–û–ó–ß–ò–ö</div>
            <div class="header-cell">–ê–ô–î–û–û–ß–£ ‚Ä¢ –í–û–î–ò–¢–ï–õ–¨</div>
            <div class="header-cell">–ë–ê–ê–°–´ ‚Ä¢ –¶–ï–ù–ê</div>
        </div>

        <div class="departures" id="departures-container">
            <!-- –†–µ–π—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
        </div>

        <div class="ticker">
            <div class="ticker-text" id="ticker-text">
                –ö–ê–†–ê–ö–û–õ –ê–í–¢–û–ë–ï–ö–ï–¢–ò ‚Ä¢ –ö–ï–¢“Æ“Æ–õ”®–† –ö“Æ–ù–î”® 06:00–¥”©–Ω 22:00–≥”© —á–µ–π–∏–Ω ‚Ä¢ –ë–ò–õ–ï–¢–¢–ï–†–î–ò –ö–ê–°–°–ê–î–ê –ê–õ–´“¢–´–ó ‚Ä¢ –ë–ê–ì–ê–ñ–î–´ –ö–ê–ú–ê–ö–ö–ê –¢–û–ü–¢–û–û –ú–ò–õ–î–ï–¢–¢“Æ“Æ ‚Ä¢ –ö–û–û–ü–°–£–ó–î–£–ö –≠–†–ï–ñ–ï–õ–ï–†–ò–ù –°–ê–ö–¢–ê“¢–´–ó
            </div>
        </div>
    </div>

    <script>
        let buses = [];
        let speechQueue = [];
        let isSpeaking = false;
        let announcedEvents = new Set();
        let tickerIndex = 0;
        let lastDataHash = '';
        let currentUser = null;
        const MAX_VISIBLE_ROUTES = 10;

        const languages = {
            kg: {
                voice: 'ru-RU',
                announcements: {
                    dayStart: '–ö–∞—Ä–∞–∫–æ–ª –∞–≤—Ç–æ–±–µ–∫–µ—Ç–∏–Ω–¥–µ –∂—É–º—É—à –∫“Ø–Ω“Ø –±–∞—à—Ç–∞–ª–¥—ã',
                    dayEnd: '–ö–∞—Ä–∞–∫–æ–ª –∞–≤—Ç–æ–±–µ–∫–µ—Ç–∏–Ω–¥–µ –∂—É–º—É—à –∫“Ø–Ω“Ø –∞—è–∫—Ç–∞–¥—ã',
                    fiveMinutes: '{route} –±–∞–≥—ã—Ç—ã–Ω–∞ {vehicle} 5 –º“Ø–Ω”©—Ç—Ç”©–Ω –∫–∏–π–∏–Ω –∫–µ—Ç–µ—Ç. –ñ–æ–ª–æ–æ—á—É–ª–∞—Ä –¥–∞—è—Ä–¥–∞–Ω—ã“£—ã–∑',
                    boarding: '{route} –±–∞–≥—ã—Ç—ã–Ω–∞ {vehicle} –æ—Ç—É—Ä–≥—É–∑—É—É –±–∞—à—Ç–∞–ª–¥—ã. –ñ–æ–ª–æ–æ—á—É–ª–∞—Ä –æ—Ç—É—Ä–≥—É–∑—É—É–≥–∞ ”©—Ç“Ø“£“Ø–∑',
                    departed: '{route} –±–∞–≥—ã—Ç—ã–Ω–∞ {vehicle} –∫–µ—Ç—Ç–∏',
                    statusChange: '{route} –±–∞–≥—ã—Ç—ã–Ω–¥–∞–≥—ã {vehicle}—Ç–∏–Ω —Å—Ç–∞—Ç—É—Å—É ”©–∑–≥”©—Ä–¥“Ø'
                }
            },
            ru: {
                voice: 'ru-RU',
                announcements: {
                    dayStart: '–†–∞–±–æ—á–∏–π –¥–µ–Ω—å –Ω–∞ –∞–≤—Ç–æ–≤–æ–∫–∑–∞–ª–µ –ö–∞—Ä–∞–∫–æ–ª –Ω–∞—á–∞–ª—Å—è',
                    dayEnd: '–†–∞–±–æ—á–∏–π –¥–µ–Ω—å –Ω–∞ –∞–≤—Ç–æ–≤–æ–∫–∑–∞–ª–µ –ö–∞—Ä–∞–∫–æ–ª –∑–∞–≤–µ—Ä—à–µ–Ω',
                    fiveMinutes: '{vehicle} –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é {route} –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç. –ü–∞—Å—Å–∞–∂–∏—Ä—ã –≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ –ø–æ—Å–∞–¥–∫–µ',
                    boarding: '–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ—Å–∞–¥–∫–∞ –Ω–∞ {vehicle} –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é {route}. –ü–∞—Å—Å–∞–∂–∏—Ä—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç–µ –Ω–∞ –ø–æ—Å–∞–¥–∫—É',
                    departed: '{vehicle} –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é {route} –æ—Ç–ø—Ä–∞–≤–∏–ª—Å—è',
                    statusChange: '–°—Ç–∞—Ç—É—Å {vehicle} –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é {route} –∏–∑–º–µ–Ω–µ–Ω'
                }
            },
            en: {
                voice: 'en-US',
                announcements: {
                    dayStart: 'Working day at Karakol bus station has started',
                    dayEnd: 'Working day at Karakol bus station has ended',
                    fiveMinutes: '{vehicle} to {route} departs in 5 minutes. Passengers please prepare for boarding',
                    boarding: '{vehicle} to {route} is now boarding. Passengers please proceed to boarding',
                    departed: '{vehicle} to {route} has departed',
                    statusChange: 'Status of {vehicle} to {route} has been changed'
                }
            }
        };

        const tickerMessages = [
            '–ö–ê–†–ê–ö–û–õ –ê–í–¢–û–ë–ï–ö–ï–¢–ò ‚Ä¢ –ö–ï–¢“Æ“Æ–õ”®–† –ö“Æ–ù–î”® 06:00–¥”©–Ω 22:00–≥”© —á–µ–π–∏–Ω',
            '–ë–ò–õ–ï–¢–¢–ï–†–î–ò –ö–ê–°–°–ê–î–ê –ê–õ–´“¢–´–ó ‚Ä¢ –ù–û–ú–ï–† 1-2 ‚Ä¢ –ë–ò–õ–ï–¢–´ –í –ö–ê–°–°–ï ‚Ññ1-2',
            '–ë–ê–ì–ê–ñ–î–´ –ö–ê–ú–ê–ö–ö–ê –¢–û–ü–¢–û–û –ú–ò–õ–î–ï–¢–¢“Æ“Æ ‚Ä¢ –ë–ê–ì–ê–ñ –°–î–ê–í–ê–¢–¨ –í –ö–ê–ú–ï–†–£ –•–†–ê–ù–ï–ù–ò–Ø',
            '–ú–ê–ê–õ–´–ú–ê–¢ “Æ–ß“Æ–ù: +996 3922 5-15-15 ‚Ä¢ –°–ü–†–ê–í–ö–ò –ü–û –¢–ï–õ–ï–§–û–ù–£',
            '–ö–û–û–ü–°–£–ó–î–£–ö –≠–†–ï–ñ–ï–õ–ï–†–ò–ù –°–ê–ö–¢–ê“¢–´–ó ‚Ä¢ –°–û–ë–õ–Æ–î–ê–ô–¢–ï –ü–†–ê–í–ò–õ–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò'
        ];

        function logout() {
            const keys = [];
            keys.push('karakol-session');
            keys.push('karakol-admin-session');
            keys.forEach(key => localStorage.removeItem(key));
            showAccessDenied();
        }

        function goToLogin() {
            window.location.href = 'index.html';
        }

        function checkAccess() {
            const savedSession = JSON.parse(localStorage.getItem('karakol-session') || 'null');
            if (!savedSession) {
                showAccessDenied();
                return false;
            }

            if (savedSession.expires < Date.now()) {
                localStorage.removeItem('karakol-session');
                showAccessDenied();
                return false;
            }

            if (savedSession.role !== 'operator') {
                showAccessDenied();
                return false;
            }

            currentUser = savedSession;
            return true;
        }

        function showAccessDenied() {
            document.getElementById('access-denied').style.display = 'flex';
            document.getElementById('display-screen').style.display = 'none';
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                now.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            document.getElementById('current-date').textContent = 
                now.toLocaleDateString('ru-RU', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long'
                });
        }

        async function updateWeather() {
            try {
                const response = await fetch(`https://wttr.in/Karakol?format=j1`);
                
                if (response.ok) {
                    const data = await response.json();
                    const temp = Math.round(data.current_condition[0].temp_C);
                    const sign = temp > 0 ? '+' : '';
                    document.getElementById('weather-temp').textContent = `${sign}${temp}¬∞`;
                } else {
                    useLocalWeather();
                }
            } catch (error) {
                useLocalWeather();
            }
        }

        function useLocalWeather() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const hour = now.getHours();
            let temp;
            
            if (month >= 12 || month <= 2) { 
                temp = Math.floor(Math.random() * 15) - 10;
                if (hour >= 22 || hour <= 6) temp -= 3;
            } else if (month >= 3 && month <= 5) { 
                temp = Math.floor(Math.random() * 20) + 5;
                if (hour >= 12 && hour <= 16) temp += 3;
            } else if (month >= 6 && month <= 8) { 
                temp = Math.floor(Math.random() * 15) + 15;
                if (hour >= 12 && hour <= 16) temp += 5;
            } else { 
                temp = Math.floor(Math.random() * 20) + 0;
                if (hour >= 22 || hour <= 6) temp -= 2;
            }
            
            const sign = temp > 0 ? '+' : '';
            document.getElementById('weather-temp').textContent = `${sign}${temp}¬∞`;
        }

        function updateTicker() {
            const text = tickerMessages[tickerIndex];
            document.getElementById('ticker-text').textContent = text;
            tickerIndex = (tickerIndex + 1) % tickerMessages.length;
        }

        function renderRoutes() {
            const container = document.getElementById('departures-container');
            
            if (buses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üöå</div>
                        <div class="empty-text">–ê–≤—Ç–æ–±—É—Å—Ç–∞—Ä –∂–æ–∫ ‚Ä¢ –ù–µ—Ç –∞–≤—Ç–æ–±—É—Å–æ–≤</div>
                    </div>
                `;
                return;
            }

            const sorted = [...buses]
                .sort((a, b) => {
                    const timeA = parseTimeToMinutes(a.time);
                    const timeB = parseTimeToMinutes(b.time);
                    return timeA - timeB;
                })
                .slice(0, MAX_VISIBLE_ROUTES);

            container.innerHTML = sorted.map(bus => `
                <div class="route">
                    <div class="route-destination">${bus.route}</div>
                    <div class="route-time">${bus.time}</div>
                    <div class="route-status status-${bus.status}">
                        ${getStatusText(bus.status)}
                    </div>
                    <div class="route-vehicle">${getVehicleText(bus.vehicle)}</div>
                    <div class="route-seats">${bus.seats}</div>
                    <div class="route-available">${bus.available || bus.seats}</div>
                    <div class="route-carrier">${bus.carrier}</div>
                    <div class="route-driver">${bus.driver}</div>
                    <div class="route-price">${bus.price || '---'} —Å–æ–º</div>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const texts = {
                'waiting': '–ö“Ø—Ç“Ø“Ø–¥”©',
                'boarding': '–û—Ç—É—Ä–≥—É–∑—É—É',
                'delayed': '–ö–µ—á–∏–≥“Ø“Ø',
                'departed': '–ö–µ—Ç—Ç–∏'
            };
            return texts[status] || status;
        }

        function getVehicleText(vehicle) {
            const texts = {
                'bus': '–ê–≤—Ç–æ–±—É—Å',
                'minibus': '–ú–∞—Ä—à—Ä—É—Ç–∫–∞'
            };
            return texts[vehicle] || '–ê–≤—Ç–æ–±—É—Å';
        }

        function parseTimeToMinutes(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function makeTrilingualAnnouncement(type, route = '', vehicle = '', busId = null, isManual = false) {
            const announceKey = busId ? `${busId}_${type}` : `${type}_${Date.now()}`;
            
            if (announcedEvents.has(announceKey) && !isManual) return;
            announcedEvents.add(announceKey);
            
            console.log(`üîä –û–±—ä—è–≤–ª–µ–Ω–∏–µ: ${type} –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞ ${route}`);
            
            const vehicleTextKg = getVehicleText(vehicle);
            const vehicleTextRu = vehicle === 'bus' ? '–∞–≤—Ç–æ–±—É—Å' : '–º–∞—Ä—à—Ä—É—Ç–∫–∞';
            const vehicleTextEn = vehicle === 'bus' ? 'bus' : 'minibus';
            
            // –ö—ã—Ä–≥—ã–∑—Å–∫–∏–π
            let kgText = languages.kg.announcements[type] || '';
            if (route && vehicle) {
                kgText = kgText.replace('{route}', route).replace('{vehicle}', vehicleTextKg);
            }
            addSpeech(kgText, languages.kg.voice, '–ö—ã—Ä–≥—ã–∑—Å–∫–∏–π');
            
            // –†—É—Å—Å–∫–∏–π —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                let ruText = languages.ru.announcements[type] || '';
                if (route && vehicle) {
                    ruText = ruText.replace('{route}', route).replace('{vehicle}', vehicleTextRu);
                }
                addSpeech(ruText, languages.ru.voice, '–†—É—Å—Å–∫–∏–π');
            }, 4000);
            
            // –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —á–µ—Ä–µ–∑ 8 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                let enText = languages.en.announcements[type] || '';
                if (route && vehicle) {
                    enText = enText.replace('{route}', route).replace('{vehicle}', vehicleTextEn);
                }
                addSpeech(enText, languages.en.voice, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π');
            }, 8000);
        }

        function addSpeech(text, voice, language) {
            speechQueue.push({ text, voice, language });
            console.log(`üìù –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å [${language}]: "${text}"`);
        }

        function processSpeech() {
            if (!isSpeaking && speechQueue.length > 0) {
                const speech = speechQueue.shift();
                speak(speech.text, speech.voice, speech.language);
            }
        }

        function speak(text, voiceLang, language) {
            if (!('speechSynthesis' in window)) {
                console.log('‚ùå Speech synthesis –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                isSpeaking = false;
                return;
            }
            
            speechSynthesis.cancel();
            isSpeaking = true;
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (voiceLang === 'en-US') {
                utterance.lang = 'en-US';
                utterance.rate = 0.7;
                utterance.pitch = 1.0;
            } else {
                utterance.lang = 'ru-RU';
                utterance.rate = 0.75;
                utterance.pitch = 1.0;
            }
            
            const setVoice = () => {
                const voices = speechSynthesis.getVoices();
                let selectedVoice = null;
                
                if (voiceLang === 'en-US') {
                    selectedVoice = voices.find(voice => 
                        voice.lang === 'en-US' && (
                            voice.name.includes('Google') || 
                            voice.name.includes('Microsoft') ||
                            voice.name.includes('Samantha') ||
                            voice.name.includes('Karen') ||
                            voice.name.includes('Daniel')
                        )
                    ) || voices.find(voice => voice.lang === 'en-US') 
                      || voices.find(voice => voice.lang.startsWith('en'));
                } else {
                    selectedVoice = voices.find(voice => 
                        voice.lang === 'ru-RU' && (
                            voice.name.includes('Google') || 
                            voice.name.includes('Microsoft') ||
                            voice.name.includes('Yandex')
                        )
                    ) || voices.find(voice => voice.lang === 'ru-RU') 
                      || voices.find(voice => voice.lang.startsWith('ru'));
                }
                
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                    console.log(`üé§ –ì–æ–ª–æ—Å: ${selectedVoice.name} [${language}]`);
                } else {
                    console.log(`‚ö†Ô∏è –ì–æ–ª–æ—Å –¥–ª—è ${voiceLang} –Ω–µ –Ω–∞–π–¥–µ–Ω [${language}]`);
                }
                
                utterance.volume = 0.9;
                
                utterance.onstart = () => {
                    console.log(`üîä –ü—Ä–æ–∏–∑–Ω–æ—à—É [${language}]: "${text}"`);
                };
                
                utterance.onend = () => {
                    console.log(`‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ [${language}]: "${text}"`);
                    isSpeaking = false;
                };
                
                utterance.onerror = (event) => {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ speech [${language}]:`, event.error);
                    isSpeaking = false;
                };
                
                speechSynthesis.speak(utterance);
            };
            
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.addEventListener('voiceschanged', setVoice, { once: true });
            } else {
                setVoice();
            }
        }

        // –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –°–¢–ê–¢–£–°–û–í: waiting -> boarding (–ø—Ä–æ—Å—Ç–æ—è—Ç—å 5 –º–∏–Ω) -> departed (—á–µ—Ä–µ–∑ 2 –º–∏–Ω –∏—Å—á–µ–∑–Ω—É—Ç—å)
        function checkAnnouncements() {
            const now = new Date();
            const currentHours = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentTotalMinutes = currentHours * 60 + currentMinutes;
            
            console.log(`‚è∞ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π: ${currentHours}:${currentMinutes.toString().padStart(2, '0')}`);
            
            buses.forEach(bus => {
                if (!bus.announcements) {
                    bus.announcements = {
                        fiveMinutes: false,
                        boarding: false,
                        departed: false,
                        statusManual: false
                    };
                }
                
                const [busHours, busMinutes] = bus.time.split(':').map(Number);
                const busTotalMinutes = busHours * 60 + busMinutes;
                const diffMinutes = busTotalMinutes - currentTotalMinutes;

                // –ó–∞ 5 –º–∏–Ω—É—Ç –¥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –æ–±—ä—è–≤–ª–µ–Ω–∏–µ, —Å—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–µ—Ç—Å—è waiting
                if (diffMinutes === 5 && !bus.announcements.fiveMinutes && bus.status === 'waiting') {
                    console.log(`üì¢ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –∑–∞ 5 –º–∏–Ω—É—Ç: ${bus.route}`);
                    bus.announcements.fiveMinutes = true;
                    makeTrilingualAnnouncement('fiveMinutes', bus.route, bus.vehicle, bus.id);
                }

                // –¢–æ—á–Ω–æ –≤ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–µ–Ω—è–µ–º –Ω–∞ boarding
                if (diffMinutes === 0 && bus.status === 'waiting') {
                    console.log(`üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ –ø–æ—Å–∞–¥–∫—É: ${bus.route}`);
                    bus.status = 'boarding';
                    bus.boardingStartTime = now; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∫–æ–≥–¥–∞ –Ω–∞—á–∞–ª–∞—Å—å –ø–æ—Å–∞–¥–∫–∞
                    if (!bus.announcements.boarding) {
                        bus.announcements.boarding = true;
                        makeTrilingualAnnouncement('boarding', bus.route, bus.vehicle, bus.id);
                    }
                }

                // –ß–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –ø–æ—Å–∞–¥–∫–∏ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–µ–Ω—è–µ–º –Ω–∞ departed
                if (bus.status === 'boarding' && bus.boardingStartTime) {
                    const timeSinceBoarding = (now - new Date(bus.boardingStartTime)) / (1000 * 60); // –≤ –º–∏–Ω—É—Ç–∞—Ö
                    if (timeSinceBoarding >= 5 && !bus.announcements.departed) {
                        console.log(`üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ departed: ${bus.route}`);
                        bus.status = 'departed';
                        bus.departedTime = now; // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è –∫–æ–≥–¥–∞ —Å—Ç–∞–ª departed
                        bus.announcements.departed = true;  
                        makeTrilingualAnnouncement('departed', bus.route, bus.vehicle, bus.id);
                    }
                }

                // –†—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
                if (bus.statusChanged && !bus.announcements.statusManual) {
                    console.log(`üì¢ –†—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞: ${bus.route}`);
                    bus.announcements.statusManual = true;
                    makeTrilingualAnnouncement('statusChange', bus.route, bus.vehicle, bus.id, true);
                    bus.statusChanged = false;
                }
            });
            
            saveToLocalStorage();
        }

        function removeOldBuses() {
            const now = new Date();
            const initialCount = buses.length;
            
            // –£–¥–∞–ª—è–µ–º –∞–≤—Ç–æ–±—É—Å—ã –∫–æ—Ç–æ—Ä—ã–µ –≤ —Å—Ç–∞—Ç—É—Å–µ departed —É–∂–µ –±–æ–ª–µ–µ 2 –º–∏–Ω—É—Ç
            buses = buses.filter(bus => {
                if (bus.status === 'departed' && bus.departedTime) {
                    const timeSinceDeparted = (now - new Date(bus.departedTime)) / (1000 * 60); // –≤ –º–∏–Ω—É—Ç–∞—Ö
                    if (timeSinceDeparted >= 2) {
                        console.log(`üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞: ${bus.route} (–ø—Ä–æ—à–ª–æ ${timeSinceDeparted.toFixed(1)} –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ departed)`);
                        return false; // –£–¥–∞–ª—è–µ–º —Å –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
                    }
                }
                return true; // –û—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
            });

            if (buses.length < initialCount) {
                console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ —Å –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ ${initialCount - buses.length} –∞–≤—Ç–æ–±—É—Å–æ–≤`);
                renderRoutes();
                saveToLocalStorage();
            }
        }

        function loadDataFromStorage() {
            try {
                const savedData = JSON.parse(localStorage.getItem('karakol-bus-station-display') || '{}');
                const newBuses = savedData.buses || [];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–±—ã—Ç–∏—è –¥–Ω—è
                if (savedData.dayStarted && !announcedEvents.has('dayStart')) {
                    console.log('üì¢ –î–µ–Ω—å —É–∂–µ –±—ã–ª –Ω–∞—á–∞—Ç');
                }
                
                if (savedData.dayEnded && !announcedEvents.has('dayEnd')) {
                    makeTrilingualAnnouncement('dayEnd');
                    announcedEvents.add('dayEnd');
                }
                
                if (savedData.dayStarted && !savedData.dayEnded && !announcedEvents.has('dayStart')) {
                    makeTrilingualAnnouncement('dayStart');
                    announcedEvents.add('dayStart');
                }
                
                const newDataHash = JSON.stringify(newBuses.map(b => ({
                    id: b.id, 
                    route: b.route,
                    time: b.time,
                    status: b.status, 
                    seats: b.seats,
                    available: b.available,
                    carrier: b.carrier,
                    driver: b.driver,
                    price: b.price,
                    vehicle: b.vehicle
                })));
                
                if (newDataHash !== lastDataHash) {
                    console.log('üîÑ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ');
                    buses = newBuses;
                    renderRoutes();
                    lastDataHash = newDataHash;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
            }
        }

        function saveToLocalStorage() {
            try {
                const displayData = {
                    buses: buses,
                    lastUpdate: new Date().toISOString()
                };
                localStorage.setItem('karakol-bus-station-display', JSON.stringify(displayData));
                console.log('üì± –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            }
        }

        window.addEventListener('storage', function(e) {
            if (e.key === 'karakol-bus-station-display') {
                loadDataFromStorage();
            }
        });

        function init() {
            if (!checkAccess()) {
                return;
            }

            console.log('üöå –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –ö–∞—Ä–∞–∫–æ–ª –∞–≤—Ç–æ–±–µ–∫–µ—Ç–∏ –∑–∞–ø—É—â–µ–Ω');
            
            updateTime();
            updateWeather();
            updateTicker();
            
            setInterval(updateTime, 1000);
            setInterval(updateWeather, 600000);
            setInterval(updateTicker, 20000);
            
            loadDataFromStorage();
            setInterval(loadDataFromStorage, 2000);
            setInterval(removeOldBuses, 60000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –ø—Ä–æ–≤–µ—Ä—è–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
            
            setInterval(processSpeech, 1500);
            setInterval(checkAnnouncements, 30000); // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å—ã
            
            if ('speechSynthesis' in window) {
                speechSynthesis.getVoices();
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = () => {
                        console.log('üé§ –ì–æ–ª–æ—Å–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', speechSynthesis.getVoices().length);
                    };
                }
            }
        }

        window.addEventListener('load', function() {
            init();
        });

        setInterval(() => {
            if (!checkAccess()) {
                return;
            }
        }, 300000);
    </script>
</body>
</html>